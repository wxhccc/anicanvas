"use strict";function createHtmlElement(t,e,i){var n=document.createElement(t);return isType(e,"object")&&Object.assign(n,e),isType(i,"object")&&Object.assign(n.style,i),n}function objectFilter(t,e,i){var n={};return isType(t,"object")&&isType(e,"array")&&e.forEach(function(e){t.hasOwnProperty(e)?n[e]=t[e]:i&&(n[e]=void 0)}),n}function isType(t,e){return"string"==typeof e?Object.prototype.toString.call(t).toLowerCase()==="[object "+e.toLowerCase()+"]":null}function isNumeric(t){return(isType(t,"number")||isType(t,"string"))&&!isNaN(t-parseFloat(t))}function jsonEqual(t,e){return JSON.stringify(t)===JSON.stringify(e)}function getUniqueTime(){return Math.floor(1e3*(+new Date+Math.random()))}function objKeySort(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.sort(function(t,n){return void 0!==t[e]&&void 0!==n[e]?t[e]<n[e]?i?1:-1:t[e]>n[e]?i?-1:1:0:0})}function deg2rad(t){return Math.PI/180*t}function errWarn(t){console.log(t)}var _Event$eventMap,classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),defineProperty=function(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t},get=function t(e,i,n){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,i);if(void 0===a){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,i,n)}if("value"in a)return a.value;var s=a.get;return void 0!==s?s.call(n):void 0},inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)},Event=function(){function t(){classCallCheck(this,t),this._isBindEvent=!1}return createClass(t,[{key:"on",value:function(e,i,n){if(Array.isArray(i)||!n){var a=t.eventMap;if(isType(i,"function")&&(n=i,i=null),a.hasOwnProperty(e)&&isType(n,"function")){!a[e][this._id]&&(a[e][this._id]={self:[],children:{}});var r=a[e][this._id];if(!n._cbid&&(n._cbid="e"+getUniqueTime()),i){var s=r.children;i.forEach(function(t){s[t]?!s[t].find(function(t){return t._cbid===n._cbid})&&s[t].push(n):s[t]=[n]})}else{var o=r.self;!o.find(function(t){return t._cbid===n._cbid})&&o.push(n)}}}}},{key:"off",value:function(e,i,n){if(Array.isArray(i)||!n){var a=t.eventMap;if(isType(i,"function")&&(n=i,i=null),a.hasOwnProperty(e))if(void 0!==i||void 0!==n){var r=t.eventMap[e][this._id];if(r&&n._cbid&&null===i&&Array.isArray(i))if(i){var s=r.children;void 0===n?i.forEach(function(t){return delete s[t]}):n&&n._cbid&&i.forEach(function(t){var e=s[t];if(e&&e.length>0){var i=e.findIndex(function(t){return t._cbid===n._cbid});i>=0&&e.splice(i,1)}})}else{var o=r.self;if(void 0===n)o.self=[];else if(n&&n._cbid){var u=o.findIndex(function(t){return t._cbid===n._cbid});u>=0&&o.splice(u,1)}}}else delete t.eventMap[e][this._id]}}}],[{key:"eventCapture",value:function(e,i){for(var n=e.length-1;n>=0;n--){var a=e[n],r=a._stage,s=a._ctx;if(t.searchTargetSprite(r,{event:i,context:s}))break}}},{key:"searchTargetSprite",value:function(e,i){var n=e.children,a=(e._id,i.event),r=i.event,s=r.offsetX,o=r.offsetY,u=i.context,h=n.length;if(e.isPointInpath({x:s,y:o},u)){if(a.targetSprite=e,0==h)return!0;for(var l=h-1;l>=0;l--)if(t.searchTargetSprite(n[l],i))return!0}}},{key:"eventBubbling",value:function(e,i){var n=[],a=e.targetSprite,r=a||{},s=r._id,o=r.name,u=r.$parent;i[s]&&i[s].self.length&&n.push.apply(n,toConsumableArray(t.runtimeBinding(i[s].self,a,e)));for(var h=u;h;)if(h._isBindEvent&&!i[h._id]){var l=i[h._id];l.self.length&&n.push.apply(n,toConsumableArray(t.runtimeBinding(l.self,h,e)));var c=l.children;c&&c[o]&&n.push.apply(n,toConsumableArray(t.runtimeBinding(c[o],h,e))),h=h.$parent}else h=h.$parent;return n}},{key:"runtimeBinding",value:function(t,e,i){return t.map(function(t){return t.bind(e,i)})}}]),t}();Event.eventMap=(defineProperty(_Event$eventMap={click:{},mouseenter:{},mouseover:{},mousemove:{},mousedown:{},mouseup:{}},"click",{}),defineProperty(_Event$eventMap,"dblclick",{}),defineProperty(_Event$eventMap,"contextmenu",{}),defineProperty(_Event$eventMap,"wheel",{}),defineProperty(_Event$eventMap,"touchstart",{}),defineProperty(_Event$eventMap,"touchmove",{}),defineProperty(_Event$eventMap,"touchend",{}),_Event$eventMap);var Media=function(){function t(){classCallCheck(this,t)}return createClass(t,[{key:"play",value:function(t){this[t]&&this[t].play&&this[t].play()}},{key:"pause",value:function(t){this[t]&&this[t].pause&&this[t].pause()}}]),t}(),relevantProps={top:0,left:0,width:0,height:0,velocityX:0,velocityY:0,rotateVelocity:0,rotate:0,opacity:1,visible:!0,animating:!1,zindex:0,destroy:!1,rotatePoint:{x:0,y:0}},Sprite=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};classCallCheck(this,e);var r=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r._startTime=0,r._autoRP=!0,r.needUpdate=!1,r.$data={},r.$media=new Media,r.children=[],r.isPointInpath=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],i=!1,n=t.x,a=t.y;if(isNumeric(n)&&isNumeric(a))if(r._path&&e)r._path(e),i=e.isPointInPath(n,a);else{var s=r.left,o=r.top,u=r.width,h=r.height;if(r.$parent){var l=r.$parent;s+=l.left,o+=l.top}i=n>=s&&n<=s+u&&a>=o&&a<=o+h}return i},r.name=t,r._id="s"+getUniqueTime(),r._painter=n,r.behaviors=Array.isArray(a)?a:[],r.injectRelevantProps(),r.initArgs(i),r}return inherits(e,Event),createClass(e,[{key:"initArgs",value:function(t){Object.assign(this,t),!this.needAutoRP&&(this.rotatePoint=this._spriteRP())}},{key:"injectRelevantProps",value:function(){var t=this;Object.keys(relevantProps).forEach(function(e){var i=relevantProps[e],n=t;Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return i},set:function(t){n.needAutoRP&&n._checkAutoRp(e,t),t===i||jsonEqual(t,i)||(i=t,n.needAutoRP&&n._autoRotatePoint(e),n.needUpdate=!0)}})})}},{key:"_checkAutoRp",value:function(t,e){"rotatePoint"===t&&isType(e,"object")&&(e.auto?delete e.auto:this._autoRP=!1)}},{key:"_autoRotatePoint",value:function(t){this.needAutoRP&&this._autoRP&&["left","top","width","height"].indexOf(t)>=0&&(this.rotatePoint=this._spriteRP(!0))}},{key:"_spriteRP",value:function(t){var e={x:this.left+this.width/2,y:this.top+this.height/2};return t&&(e.auto=!0),e}},{key:"setPath",value:function(t){isType(t,"function")&&(this._path=t)}},{key:"paint",value:function(t,e,i,n){if(this._painter&&this._painter.paint&&this.visible){var a=this.$parent||{left:0,top:0},r=a.left,s=a.top;t.save(),t.translate(r,s),this._painter.paint(this,t,e,i,n),t.restore()}this.children.length&&this.children.forEach(function(n){return n.paint&&n.paint(t,e,i)}),this.needUpdate=!1}},{key:"update",value:function(t,e,i,n){!this._startTime&&(this._startTime=t),this._runBehaviors(t,e,i,n),this.children.length&&this.children.forEach(function(a,r,s){a.destroy?s.splice(r,1):a.update(t,e,i,n)}),this.needUpdate&&(n.isStatic=!1)}},{key:"append",value:function(){for(var t=this,e=this.children,i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];e.push.apply(e,n),n.forEach(function(e){return e.$parent=t}),objKeySort(e,"zindex")}},{key:"addBehaviors",value:function(){for(var t,e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];this._behaviorsSigned(i),(t=this.behaviors).push.apply(t,i)}},{key:"_behaviorsSigned",value:function(t){t.forEach(function(t){!t._bid&&(t._bid=+new Date)})}},{key:"_runBehaviors",value:function(t,e,i,n){var a=this.behaviors,r=this._startTime,s=!0,o=!1,u=void 0;try{for(var h,l=a[Symbol.iterator]();!(s=(h=l.next()).done);s=!0){var c=h.value;if(c.delay){if(t-r-c.delay<0)continue;t=t-r-c.delay}isType(c.execute,"function")&&c.execute(this,t,e,i,n)}}catch(t){o=!0,u=t}finally{try{!s&&l.return&&l.return()}finally{if(o)throw u}}}},{key:"$path",get:function(){return this._path}}]),e}(),BaseLayer=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"BASELAYER-"+t,i))}return inherits(e,Sprite),createClass(e,[{key:"paint",value:function(t,i,n,a){if(!t.isStatic){var r=this.width,s=this.height;t.clearRect(0,0,r,s),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"paint",this).call(this,t,i,n,a)}}}]),e}(),Stage=function(){function t(e,i){var n=this;classCallCheck(this,t),this._playing=!0,this.update=function(t,e,i){var a=n._ctx;a.isStatic=!0,n._playing&&(n._stage.update(t,e,i,a),n._stage.paint(a,t,e,i))},this.append=function(){var t;(t=n._stage).append.apply(t,arguments)},this.$canvas=this.elemInit(e,i),this.resetOptions(i,!0),this.stageInit(e),this.$layers={}}return createClass(t,[{key:"resetOptions",value:function(t,e){e||!this._options?this._options=Object.assign({},t):Object.assign(this._options,t),this.zIndex=this._options.zIndex||0}},{key:"elemInit",value:function(t,e){var i=objectFilter(e,["width","height"]),n=Object.assign({},e,{position:"absolute"}),a=isType(t,"string")?createHtmlElement("canvas",i,n):t;return(a=isType(a,"HTMLCanvasElement")?a:null)&&(a.id="AC_"+t),a}},{key:"stageInit",value:function(t){var e=objectFilter(this._options,["width","height"]);this._stage=new BaseLayer(t,e),this.$canvas?this._ctx=this.$canvas.getContext("2d"):errWarn("no accessable canvas element!")}},{key:"play",value:function(){this._playing=!0}},{key:"pause",value:function(){this._playing=!1}},{key:"setCanvasSize",value:function(){var t=this._options,e=t.width,i=t.height;isNumeric(e)&&isNumeric(i)&&Object.assign(this.$canvas,{width:e,height:i})}},{key:"resize",value:function(){this.setCanvasSize()}}]),t}(),relevantProps$1={top:0,left:0,width:0,height:0,velocityX:0,velocityY:0,rotateVelocity:0,rotate:0,opacity:1,visible:!0,animating:!1,zindex:0,destroy:!1,rotatePoint:{x:0,y:0}},Sprite$1=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};classCallCheck(this,e);var r=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r._startTime=0,r._autoRP=!0,r.needUpdate=!1,r.$data={},r.$media=new Media,r.children=[],r.isPointInpath=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],i=!1,n=t.x,a=t.y;if(isNumeric(n)&&isNumeric(a))if(r._path&&e)r._path(e),i=e.isPointInPath(n,a);else{var s=r.left,o=r.top,u=r.width,h=r.height;if(r.$parent){var l=r.$parent;s+=l.left,o+=l.top}i=n>=s&&n<=s+u&&a>=o&&a<=o+h}return i},r.name=t,r._id="s"+getUniqueTime(),r._painter=n,r.behaviors=Array.isArray(a)?a:[],r.injectRelevantProps(),r.initArgs(i),r}return inherits(e,Event),createClass(e,[{key:"initArgs",value:function(t){Object.assign(this,t),!this.needAutoRP&&(this.rotatePoint=this._spriteRP())}},{key:"injectRelevantProps",value:function(){var t=this;Object.keys(relevantProps$1).forEach(function(e){var i=relevantProps$1[e],n=t;Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return i},set:function(t){n.needAutoRP&&n._checkAutoRp(e,t),t===i||jsonEqual(t,i)||(i=t,n.needAutoRP&&n._autoRotatePoint(e),n.needUpdate=!0)}})})}},{key:"_checkAutoRp",value:function(t,e){"rotatePoint"===t&&isType(e,"object")&&(e.auto?delete e.auto:this._autoRP=!1)}},{key:"_autoRotatePoint",value:function(t){this.needAutoRP&&this._autoRP&&["left","top","width","height"].indexOf(t)>=0&&(this.rotatePoint=this._spriteRP(!0))}},{key:"_spriteRP",value:function(t){var e={x:this.left+this.width/2,y:this.top+this.height/2};return t&&(e.auto=!0),e}},{key:"setPath",value:function(t){isType(t,"function")&&(this._path=t)}},{key:"paint",value:function(t,e,i,n){if(this._painter&&this._painter.paint&&this.visible){var a=this.$parent||{left:0,top:0},r=a.left,s=a.top;t.save(),t.translate(r,s),this._painter.paint(this,t,e,i,n),t.restore()}this.children.length&&this.children.forEach(function(n){return n.paint&&n.paint(t,e,i)}),this.needUpdate=!1}},{key:"update",value:function(t,e,i,n){!this._startTime&&(this._startTime=t),this._runBehaviors(t,e,i,n),this.children.length&&this.children.forEach(function(a,r,s){a.destroy?s.splice(r,1):a.update(t,e,i,n)}),this.needUpdate&&(n.isStatic=!1)}},{key:"append",value:function(){for(var t=this,e=this.children,i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];e.push.apply(e,n),n.forEach(function(e){return e.$parent=t}),objKeySort(e,"zindex")}},{key:"addBehaviors",value:function(){for(var t,e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];this._behaviorsSigned(i),(t=this.behaviors).push.apply(t,i)}},{key:"_behaviorsSigned",value:function(t){t.forEach(function(t){!t._bid&&(t._bid=+new Date)})}},{key:"_runBehaviors",value:function(t,e,i,n){var a=this.behaviors,r=this._startTime,s=!0,o=!1,u=void 0;try{for(var h,l=a[Symbol.iterator]();!(s=(h=l.next()).done);s=!0){var c=h.value;if(c.delay){if(t-r-c.delay<0)continue;t=t-r-c.delay}isType(c.execute,"function")&&c.execute(this,t,e,i,n)}}catch(t){o=!0,u=t}finally{try{!s&&l.return&&l.return()}finally{if(o)throw u}}}},{key:"$path",get:function(){return this._path}}]),e}(),Painter=function(){function t(e){classCallCheck(this,t),this.image=null,this.paint_queue=[],this.photo=null,isType(e,"function")&&(this.paint=e.bind(this))}return createClass(t,[{key:"paint",value:function(t,e,i,n,a){}},{key:"addQueueFn",value:function(t){var e=isType(t,"function")?t:isType(this[t],"function")?this[t]:null;e&&this.paint_queue.push(e)}},{key:"clearQueue",value:function(){this.paint_queue=[]}},{key:"runQueue",value:function(t,e,i,n,a){for(var r=this.paint_queue,s=0;s<r.length;s++)r[s](t,e,i,n,a)}},{key:"_setSelfStyles",value:function(t,e){t.opacity<1&&(e.globalAlpha=t.opacity>0?t.opacity:0)}},{key:"rotate",value:function(t,e,i,n,a){e.translate(t.rotatePoint.x,t.rotatePoint.y),e.rotate(deg2rad(t.rotate)),t.left=-t.width/2,t.top=-t.height/2}},{key:"getPhoto",value:function(t,e){t.$data.photo=e.getImageData(t.left,t.top,t.width,t.height)}},{key:"putPhoto",value:function(t,e){e.putImageData(t.$data.photo,t.left,t.top)}}]),t}(),ImagePainter=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments[1];classCallCheck(this,e);var n=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.image=t,n.imgSet=i||{x:0,y:0,w:t&&t.width,h:t&&t.height},n}return inherits(e,Painter),createClass(e,[{key:"paint",value:function(t,e,i,n,a){if(this.image){e.save();var r=Object.assign({},t);this._setSelfStyles(r,e),this.runQueue(r,e,i,n,a);var s=this.imgSet;e.drawImage(this.image,s.x,s.y,s.w,s.h,r.left,r.top,r.width,r.height),e.restore()}}}]),e}(),SheetPainter=function(t){function e(t,i,n){var a=n.interval,r=void 0===a?1e3:a,s=n.autoruning,o=void 0!==s&&s,u=n.iteration,h=void 0===u?1:u,l=n.reverse,c=void 0!==l&&l;classCallCheck(this,e);var f=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return f.image=t,f.cells=i,f.reverse=c,f.cell_index=c?f.cells.length-1:0,f.interval=r,f.running=!!o,f.frame_point=0,f.timeline=0,f.iteration="infinite"==h?h:parseInt(h),f._countFramePoint(f.cell_index),f}return inherits(e,Painter),createClass(e,[{key:"advance",value:function(){(this.reverse?1==this.cell_index:this.cell_index==this.cells.length-2)&&(this.frame_point=this.timeline=0,Number.isInteger(this.iteration)&&this.iteration--),this.reverse?this.cell_index+=this.cells.length-1:this.cell_index++,this.cell_index%=this.cells.length,this._countFramePoint(this.cell_index)}},{key:"_countFramePoint",value:function(t){var e=(this.reverse?t+this.cells.length-1:t+1)%this.cells.length;this.frame_point+=this._sValue(this.cells[e].interval,this.interval)}},{key:"skip",value:function(t){this.cell_index=t%this.cells.length}},{key:"paint",value:function(t,e,i,n,a){if(this.running){(this.iteration>0||"infinite"==this.iteration)&&this.timeline>=this.frame_point&&this.advance();var r=this.cells[this.cell_index],s=r.img?this.image[r.img]:this.image,o=this._sValue;e.save(),e.drawImage(s,r.x,r.y,r.w,r.h,o(r.sl,t.left),o(r.st,t.top),o(r.sw,t.width),o(r.sh,t.height)),this.timeline+=n,e.restore()}}},{key:"_sValue",value:function(t,e){return Number.isFinite(t)?t:e}}]),e}(),AnimationTimer=function(){function t(e){classCallCheck(this,t),this._animation=isType(e,"function")?e:function(){},this.startTime=0,this.lastTime=0,this.running=!1,this._playing=!1,this.time=0,this.elapsed=0,this.frameRate=0,this._lastFRupdate=0,this._animHandle=null}return createClass(t,[{key:"updateFrameRate",value:function(t,e){t-this._lastFRupdate>1e3&&(this._lastFRupdate=t,this.frameRate=Math.round(1e3/e))}},{key:"start",value:function(){var t=this;if(!this.running){this.startTime=+new Date,this.running=!0,this.play();this._animHandle=window.requestAnimationFrame(function e(i){t._playing&&(!t.lastTime&&(t.lastTime=i),t.time=i-t.lastTime,t.elapsed+=t.time,t.lastTime=i,t.updateFrameRate(t.elapsed,t.time),t._animation(t.elapsed,t.time)),t._animHandle=window.requestAnimationFrame(e)})}}},{key:"play",value:function(){this._playing=!0}},{key:"pause",value:function(){this.lastTime=0,this.frameRate=0,this._playing=!1}},{key:"stop",value:function(){this.elapsed=+new Date-this.startTime,this.running=!1,this.frameRate=0,window.cancelAnimationFrame(this._animHandle)}},{key:"getElapsedTime",value:function(){return this.running?+new Date-this.startTime:this.elapsed}},{key:"getRuningTime",value:function(){return this.time}},{key:"getNextTime",value:function(){var t=this.time/this.duration;if(this.running)return void 0==this.timeWrap?elapsedTime:elapsedTime*(this.timeWarp(t)/t)}},{key:"isRunning",value:function(){return this.running}},{key:"reset",value:function(){this.elapsed=0}}],[{key:"getWarpTime",value:function(t,e,i){if("function"==typeof t){var n=e/i;return e*t(n)/n}}},{key:"easeIn",value:function(t){return function(e){return Math.pow(e,2*t)}}},{key:"easeOut",value:function(t){return function(e){return 1-Math.pow(1-e,2*t)}}},{key:"easeInOut",value:function(){return function(t){return t-Math.sin(2*t*Math.PI)/(2*Math.PI)}}},{key:"elastic",value:function(t){return t=t||this.def_opts.elastic_passes,function(e){return(1-Math.cos(e*Math.PI*t))*(1-e)+e}}},{key:"bounce",value:function(e){var i=t.elastic(e);return function(){return percent_complete=i(percent_complete),percent_complete<=1?percent_complete:2-percent_complete}}},{key:"linear",value:function(){return function(t){return t}}},{key:"step",value:function(){return function(t){return t}}}]),t}(),Behavior=function(){function t(e,i){classCallCheck(this,t);Object.assign(this,{firstFn:null,animation:null,iteration:1,timing:null,fillMode:null},e),this.executeFn=isType(i,"function")?i:this.animation?this._attrChange:function(){},this.timing=isType(this.timing,"function")?this.timing:isType(AnimationTimer[this.timing],"function")?AnimationTimer[this.timing](this.timingArgs):null,this.firstFn=isType(this.firstFn,"function")?this.firstFn:function(){},this._firstRun=!1,this._iterationCount=0,this._spriteAttrs={},this._animaProps=this._animaInitProps(),this._animaRuntime=null}return createClass(t,[{key:"_animaInitProps",value:function(){return{velocity:defineProperty({left:0,top:0,rotate:0,width:0,height:0,opacity:0},"rotate",0),lastFrame:0,frameDuration:0,framesTime:[]}}},{key:"execute",value:function(t,e,i,n,a){var r=this;this._firstRun||(this._remeberAttrs(t),this._animationPrepare(t),this.firstFn(),this._iterationCount++,this._firstRun=!0);var s=Math.floor(e/this.duration);if(s===this._iterationCount&&(this._checkIterationCount(s)&&(this._iterationCount++,this._animationPrepare(t)),"forward"!==this.fillMode&&this._remeberAttrs(t,!0)),this._checkIterationCount(s)){if(e%=this.duration,this.animation){var o=this._animaRuntime,u=this.animation,h=o.framesTime[0];if(e>=this._countFrameDuration(h)){var l=o.lastFrame=o.framesTime.shift();h=o.framesTime[0],o.frameDuration=this._countFrameDuration(h-l),o.velocity=this._attrChangeInit(t,u[h],o.frameDuration)}if(this.timing&&o.frameDuration){var c=this._warpTime(e,o.frameDuration);e=c[0],i=c[1]}}else if(this.timing&&this.duration){var f=this._warpTime(e,this.duration);e=f[0],i=f[1]}this.executeFn(t,e,i,n,a)}else{isType(this.animateCallback,"function")&&this.animateCallback(t,a);var v=t.behaviors.findIndex(function(t){return t._bid===r._bid});t.behaviors.splice(v,1)}}},{key:"_countFrameDuration",value:function(t){return t*this.duration/100}},{key:"_checkIterationCount",value:function(t){return"infinite"===this.iteration||t<this.iteration}},{key:"_animationPrepare",value:function(t){if(this.animation){this._setAnimaData(),!this.animation[0]&&!this.animation[100]&&(this.animation={0:null,100:this.animation});var e=this.animation,i=this._animaRuntime;for(var n in e)0===n&&e[0]&&this._spriteAttrSet(t,e[0],!0),i.framesTime.push(n);i.framesTime.sort(function(t,e){return t-e})}}},{key:"_setAnimaData",value:function(){this._animaRuntime=this._animaInitProps()}},{key:"_warpTime",value:function(t,e){var i=t/e,n=this.timing(i)/i*t;!this.lastTime&&(this.lastTime=n);var a=n-this.lastTime;return this.lastTime=n,this.orgTime=[n,a],this.orgTime}},{key:"_attrChangeInit",value:function(t,e,i){var n={};for(var a in e){var r=e[a],s=0;s="string"==typeof r?this._handleRelativeValue(r):r-t[a],n[a]=s/i}return n}},{key:"_attrChange",value:function(t,e,i,n,a){var r=this._animaRuntime.velocity;for(var s in r)t[s]+=r[s]*i}},{key:"_spriteAttrSet",value:function(t,e,i){for(var n in e)t[n]=i?this._handleRelativeValue(e[n],t[n]):e[n]}},{key:"_handleRelativeValue",value:function(t,e){var i=0;if("string"==typeof t&&t.indexOf("=")>0){var n=t.split("=");switch(n[0]){case"+":i=n[1]-0;break;case"-":i=-n[1]}}return isNumeric(e)&&(i+=e),i}},{key:"_remeberAttrs",value:function(t,e){if(1===Object.keys(t.behaviors).length&&(this.iteration>1||"infinite"===this.iteration)){var i=this._spriteAttrs,n=this._animaProps.velocity;if(0===Object.keys(i).length&&!e)for(var a in n)i[a]=t[a];e&&i&&this._spriteAttrSet(t,i)}}}]),t}(),MediaLoader=function(){function t(){var e=this;classCallCheck(this,t),this.loadImage=function(t,i,n,a){e.loadMedias("images",t,i,n,a)},this.getImageProgress=function(){return e.getProgress("images")},this.loadAudio=function(t,i,n,a){e.loadMedias("audios",t,i,n,a)},this.getAudioProgress=function(){return e.getProgress("audios")},this.getMediaProgress=function(){var t=e.imagesInfo.queue,i=e.audiosInfo.queue,n=i.s+i.f+t.s+t.f,a=i.t+t.t;return[n,a,Math.round(n/a*100)]},this.imagesInfo=this._mediaInfoObj(),this.images={},this.audiosInfo=this._mediaInfoObj(),this.audios={}}return createClass(t,[{key:"_mediaInfoObj",value:function(){return{total:{s:0,f:0,t:0},queue:{s:0,f:0,t:0},urls:[]}}},{key:"loadingMedia",value:function(t,e){return this.loadingImages(t.images||{},e,!0),this.loadingAudios(t.audios||{},e,!0),this}},{key:"loadingMediaList",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!!Array.isArray(e),r=this[t+"Info"],s=null;if("images"===t?s=this.loadImage:"audios"===t&&(s=this.loadAudio),e&&r&&s)for(var o in r.queue={s:0,f:0,t:0},e){s(a?e[o]:o,e[o],i,n)}return this}},{key:"loadingImages",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.loadingMediaList("images",t,e,i)}},{key:"loadMedias",value:function(t,e,i,n,a){var r=this[t+"Info"];if(Array.indexOf(r.urls,i)<0){r.total.t++,r.queue.t++,r.urls.push(i);var s=a&&this.getMediaProgress,o=null,u="load";"images"===t?(o=new Image,!a&&(s=this.getImageProgress)):"audios"===t&&(o=new Audio,!a&&(s=this.getAudioProgress),u="loadedmetadata"),o&&(o.addEventListener(u,function(){r.total.s++,r.queue.s++,100==s()[2]&&n()}),o.addEventListener("error",function(){r.total.f++,r.queue.f++,100==s()[2]&&n()}),o.src=i,this[t][e]=o)}}},{key:"loadingAudios",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.loadingMediaList("audios",t,e,i)}},{key:"getProgress",value:function(t){var e=this[t+"Info"].queue,i=e.s+e.f,n=Math.round(i/e.t*100);return[i,e.t,n]}}]),t}(),EventNames=Object.keys(Event.eventMap),Anicanvas=function(){function t(e,i){var n=this;classCallCheck(this,t),this._RAF=0,this._stages=[],this.$stages={},this.$stage=null,this.$layers={},this.$media=new MediaLoader,this.eventHandle=function(t){var e=Event.eventMap[t.type];if(e){var i=n._stages;Event.eventCapture(i,t),Event.eventBubbling(t,e).forEach(function(t){return t()})}},this.animation=function(t,e){n._stages.forEach(function(i){return i.update(t,e)})},this.append=function(){for(var t,e=arguments.length,i=Array(e),a=0;a<e;a++)i[a]=arguments[a];i.forEach(function(t){!n.$layers[t.name]&&(n.$layers[t.name]=t)}),(t=n.$stage).append.apply(t,i)},this._elem=this.elemInit(e),this._options=Object.assign({},i),this._aniTimer=new AnimationTimer(this.animation),this.stageInit()}return createClass(t,[{key:"elemInit",value:function(t){return isType(t,"string")?document.querySelector(t):null}},{key:"stageInit",value:function(){if(this._elem){this.eventListening();var t=this._options,e=t.width,i=t.height;this.createStage("MAIN",{width:e,height:i,zIndex:1e3},{left:0,top:0}),this.$stage=this.$stages.MAIN}else errWarn("no accessable root element!")}},{key:"eventListening",value:function(){var t=this;EventNames.forEach(function(e){t._elem.addEventListener(e,t.eventHandle)})}},{key:"createStage",value:function(t,e){if(isType(t,"string")&&!this.$stages[t]){var i=this._options,n=i.width,a=i.height;!e.width&&(e.width=n),!e.height&&(e.height=a);var r=new Stage(t,e);this.$stages[t]=r,this._stages.push(r),objKeySort(this._stages,"zIndex"),this._elem.appendChild(r.$canvas)}}},{key:"start",value:function(){this._aniTimer.start()}},{key:"play",value:function(){this._aniTimer.play()}},{key:"pause",value:function(){this._aniTimer.pause()}},{key:"stop",value:function(){this._aniTimer.stop()}},{key:"setCanvasSize",value:function(){var t=this._options,e=t.width,i=t.height;isNumeric(e)&&isNumeric(i)&&Object.assign(this.canvas,{width:e,height:i})}},{key:"loadingMedia",value:function(t,e){(t.images||t.audios)&&this.$media.loadingMedia(t,e)}},{key:"createPainter",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];switch(t){case"image":return new ImagePainter([].concat(i));case"sheet":return new SheetPainter([].concat(i));default:return new Painter(t)}}},{key:"resize",value:function(t){isType(t,"object")&&Object.assign(this._elem,t)}},{key:"$elemSize",get:function(){var t=this._options;return{width:t.width,height:t.height}}},{key:"frameRate",get:function(){return this._aniTimer.frameRate}}]),t}();Anicanvas.Sprite=Sprite$1,Anicanvas.Painter=Painter,Anicanvas.ImagePainter=ImagePainter,Anicanvas.SheetPainter=SheetPainter,Anicanvas.Behavior=Behavior,module.exports=Anicanvas;
