!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Anicanvas=e()}(this,function(){"use strict";function t(t,i,n){var a={};return e(t,"object")&&e(i,"array")&&i.forEach(function(e){t.hasOwnProperty(e)?a[e]=t[e]:n&&(a[e]=void 0)}),a}function e(t,e){return"string"==typeof e?Object.prototype.toString.call(t).toLowerCase()==="[object "+e.toLowerCase()+"]":null}function i(t){return(e(t,"number")||e(t,"string"))&&!isNaN(t-parseFloat(t))}function n(t,e){return JSON.stringify(t)===JSON.stringify(e)}function a(){return Math.floor(1e3*(+new Date+Math.random()))}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.sort(function(t,n){return void 0!==t[e]&&void 0!==n[e]?t[e]<n[e]?i?1:-1:t[e]>n[e]?i?-1:1:0:0})}function s(t){console.log(t)}var o,u=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},h=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),l=function(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t},c=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},f=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},v=function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)},d=function(){function t(){u(this,t),this._isBindEvent=!1}return h(t,[{key:"on",value:function(i,n,r){if(Array.isArray(n)||!r){var s=t.eventMap;if(e(n,"function")&&(r=n,n=null),s.hasOwnProperty(i)&&e(r,"function")){!s[i][this._id]&&(s[i][this._id]={self:[],children:{}});var o=s[i][this._id];if(!r._cbid&&(r._cbid="e"+a()),n){var u=o.children;n.forEach(function(t){u[t]?!u[t].find(function(t){return t._cbid===r._cbid})&&u[t].push(r):u[t]=[r]})}else{var h=o.self;!h.find(function(t){return t._cbid===r._cbid})&&h.push(r)}}}}},{key:"off",value:function(i,n,a){if(Array.isArray(n)||!a){var r=t.eventMap;if(e(n,"function")&&(a=n,n=null),r.hasOwnProperty(i))if(void 0!==n||void 0!==a){var s=t.eventMap[i][this._id];if(s&&a._cbid&&null===n&&Array.isArray(n))if(n){var o=s.children;void 0===a?n.forEach(function(t){return delete o[t]}):a&&a._cbid&&n.forEach(function(t){var e=o[t];if(e&&e.length>0){var i=e.findIndex(function(t){return t._cbid===a._cbid});i>=0&&e.splice(i,1)}})}else{var u=s.self;if(void 0===a)u.self=[];else if(a&&a._cbid){var h=u.findIndex(function(t){return t._cbid===a._cbid});h>=0&&u.splice(h,1)}}}else delete t.eventMap[i][this._id]}}}],[{key:"eventCapture",value:function(e,i){for(var n=e.length-1;n>=0;n--){var a=e[n],r=a._stage,s=a._ctx;if(t.searchTargetSprite(r,{event:i,context:s}))break}}},{key:"searchTargetSprite",value:function(e,i){var n=e.children,a=(e._id,i.event),r=i.event,s=r.offsetX,o=r.offsetY,u=i.context,h=n.length;if(e.isPointInpath({x:s,y:o},u)){if(a.targetSprite=e,0==h)return!0;for(var l=h-1;l>=0;l--)if(t.searchTargetSprite(n[l],i))return!0}}},{key:"eventBubbling",value:function(e,i){var n=[],a=e.targetSprite,r=a||{},s=r._id,o=r.name,u=r.$parent;i[s]&&i[s].self.length&&n.push.apply(n,v(t.runtimeBinding(i[s].self,a,e)));for(var h=u;h;)if(h._isBindEvent&&!i[h._id]){var l=i[h._id];l.self.length&&n.push.apply(n,v(t.runtimeBinding(l.self,h,e)));var c=l.children;c&&c[o]&&n.push.apply(n,v(t.runtimeBinding(c[o],h,e))),h=h.$parent}else h=h.$parent;return n}},{key:"runtimeBinding",value:function(t,e,i){return t.map(function(t){return t.bind(e,i)})}}]),t}();d.eventMap=(l(o={click:{},mouseenter:{},mouseover:{},mousemove:{},mousedown:{},mouseup:{}},"click",{}),l(o,"dblclick",{}),l(o,"contextmenu",{}),l(o,"wheel",{}),l(o,"touchstart",{}),l(o,"touchmove",{}),l(o,"touchend",{}),o);var p=function(){function t(){u(this,t)}return h(t,[{key:"play",value:function(t){this[t]&&this[t].play&&this[t].play()}},{key:"pause",value:function(t){this[t]&&this[t].pause&&this[t].pause()}}]),t}(),g={top:0,left:0,width:0,height:0,velocityX:0,velocityY:0,rotateVelocity:0,rotate:0,opacity:1,visible:!0,animating:!1,zindex:0,destroy:!1,rotatePoint:{x:0,y:0}},y=function(t){function s(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};u(this,s);var o=f(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return o._startTime=0,o._autoRP=!0,o.needUpdate=!1,o.$data={},o.$media=new p,o.children=[],o.isPointInpath=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],n=!1,a=t.x,r=t.y;if(i(a)&&i(r))if(o._path&&e)o._path(e),n=e.isPointInPath(a,r);else{var s=o.left,u=o.top,h=o.width,l=o.height;if(o.$parent){var c=o.$parent;s+=c.left,u+=c.top}n=a>=s&&a<=s+h&&r>=u&&r<=u+l}return n},o.name=t,o._id="s"+a(),o._painter=n,o.behaviors=Array.isArray(r)?r:[],o.injectRelevantProps(),o.initArgs(e),o}return c(s,d),h(s,[{key:"initArgs",value:function(t){Object.assign(this,t),!this.needAutoRP&&(this.rotatePoint=this._spriteRP())}},{key:"injectRelevantProps",value:function(){var t=this;Object.keys(g).forEach(function(e){var i=g[e],a=t;Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return i},set:function(t){a.needAutoRP&&a._checkAutoRp(e,t),t===i||n(t,i)||(i=t,a.needAutoRP&&a._autoRotatePoint(e),a.needUpdate=!0)}})})}},{key:"_checkAutoRp",value:function(t,i){"rotatePoint"===t&&e(i,"object")&&(i.auto?delete i.auto:this._autoRP=!1)}},{key:"_autoRotatePoint",value:function(t){this.needAutoRP&&this._autoRP&&["left","top","width","height"].indexOf(t)>=0&&(this.rotatePoint=this._spriteRP(!0))}},{key:"_spriteRP",value:function(t){var e={x:this.left+this.width/2,y:this.top+this.height/2};return t&&(e.auto=!0),e}},{key:"setPath",value:function(t){e(t,"function")&&(this._path=t)}},{key:"paint",value:function(t,e,i,n){if(this._painter&&this._painter.paint&&this.visible){var a=this.$parent||{left:0,top:0},r=a.left,s=a.top;t.save(),t.translate(r,s),this._painter.paint(this,t,e,i,n),t.restore()}this.children.length&&this.children.forEach(function(n){return n.paint&&n.paint(t,e,i)}),this.needUpdate=!1}},{key:"update",value:function(t,e,i,n){!this._startTime&&(this._startTime=t),this._runBehaviors(t,e,i,n),this.children.length&&this.children.forEach(function(a,r,s){a.destroy?s.splice(r,1):a.update(t,e,i,n)}),this.needUpdate&&(n.isStatic=!1)}},{key:"append",value:function(){for(var t=this,e=this.children,i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];e.push.apply(e,n),n.forEach(function(e){return e.$parent=t}),r(e,"zindex")}},{key:"addBehaviors",value:function(){for(var t,e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];this._behaviorsSigned(i),(t=this.behaviors).push.apply(t,i)}},{key:"_behaviorsSigned",value:function(t){t.forEach(function(t){!t._bid&&(t._bid=+new Date)})}},{key:"_runBehaviors",value:function(t,i,n,a){var r=this.behaviors,s=this._startTime,o=!0,u=!1,h=void 0;try{for(var l,c=r[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var f=l.value;if(f.delay){if(t-s-f.delay<0)continue;t=t-s-f.delay}e(f.execute,"function")&&f.execute(this,t,i,n,a)}}catch(t){u=!0,h=t}finally{try{!o&&c.return&&c.return()}finally{if(u)throw h}}}},{key:"$path",get:function(){return this._path}}]),s}(),m=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(this,e),f(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"BASELAYER-"+t,i))}return c(e,y),h(e,[{key:"paint",value:function(t,i,n,a){if(!t.isStatic){var r=this.width,s=this.height;t.clearRect(0,0,r,s),function t(e,i,n){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,i);if(void 0===a){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,i,n)}if("value"in a)return a.value;var s=a.get;return void 0!==s?s.call(n):void 0}(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"paint",this).call(this,t,i,n,a)}}}]),e}(),_=function(){function n(t,e){var i=this;u(this,n),this._playing=!0,this.update=function(t,e,n){var a=i._ctx;a.isStatic=!0,i._playing&&(i._stage.update(t,e,n,a),i._stage.paint(a,t,e,n))},this.append=function(){var t;(t=i._stage).append.apply(t,arguments)},this.$canvas=this.elemInit(t,e),this.resetOptions(e,!0),this.stageInit(t),this.$layers={}}return h(n,[{key:"resetOptions",value:function(t,e){e||!this._options?this._options=Object.assign({},t):Object.assign(this._options,t),this.zIndex=this._options.zIndex||0}},{key:"elemInit",value:function(i,n){var a=t(n,["width","height"]),r=Object.assign({},n,{position:"absolute"}),s=e(i,"string")?function(t,i,n){var a=document.createElement(t);return e(i,"object")&&Object.assign(a,i),e(n,"object")&&Object.assign(a.style,n),a}("canvas",a,r):i;return(s=e(s,"HTMLCanvasElement")?s:null)&&(s.id="AC_"+i),s}},{key:"stageInit",value:function(e){var i=t(this._options,["width","height"]);this._stage=new m(e,i),this.$canvas?this._ctx=this.$canvas.getContext("2d"):s("no accessable canvas element!")}},{key:"play",value:function(){this._playing=!0}},{key:"pause",value:function(){this._playing=!1}},{key:"setCanvasSize",value:function(){var t=this._options,e=t.width,n=t.height;i(e)&&i(n)&&Object.assign(this.$canvas,{width:e,height:n})}},{key:"resize",value:function(){this.setCanvasSize()}}]),n}(),k={top:0,left:0,width:0,height:0,velocityX:0,velocityY:0,rotateVelocity:0,rotate:0,opacity:1,visible:!0,animating:!1,zindex:0,destroy:!1,rotatePoint:{x:0,y:0}},b=function(t){function s(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};u(this,s);var o=f(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return o._startTime=0,o._autoRP=!0,o.needUpdate=!1,o.$data={},o.$media=new p,o.children=[],o.isPointInpath=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],n=!1,a=t.x,r=t.y;if(i(a)&&i(r))if(o._path&&e)o._path(e),n=e.isPointInPath(a,r);else{var s=o.left,u=o.top,h=o.width,l=o.height;if(o.$parent){var c=o.$parent;s+=c.left,u+=c.top}n=a>=s&&a<=s+h&&r>=u&&r<=u+l}return n},o.name=t,o._id="s"+a(),o._painter=n,o.behaviors=Array.isArray(r)?r:[],o.injectRelevantProps(),o.initArgs(e),o}return c(s,d),h(s,[{key:"initArgs",value:function(t){Object.assign(this,t),!this.needAutoRP&&(this.rotatePoint=this._spriteRP())}},{key:"injectRelevantProps",value:function(){var t=this;Object.keys(k).forEach(function(e){var i=k[e],a=t;Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return i},set:function(t){a.needAutoRP&&a._checkAutoRp(e,t),t===i||n(t,i)||(i=t,a.needAutoRP&&a._autoRotatePoint(e),a.needUpdate=!0)}})})}},{key:"_checkAutoRp",value:function(t,i){"rotatePoint"===t&&e(i,"object")&&(i.auto?delete i.auto:this._autoRP=!1)}},{key:"_autoRotatePoint",value:function(t){this.needAutoRP&&this._autoRP&&["left","top","width","height"].indexOf(t)>=0&&(this.rotatePoint=this._spriteRP(!0))}},{key:"_spriteRP",value:function(t){var e={x:this.left+this.width/2,y:this.top+this.height/2};return t&&(e.auto=!0),e}},{key:"setPath",value:function(t){e(t,"function")&&(this._path=t)}},{key:"paint",value:function(t,e,i,n){if(this._painter&&this._painter.paint&&this.visible){var a=this.$parent||{left:0,top:0},r=a.left,s=a.top;t.save(),t.translate(r,s),this._painter.paint(this,t,e,i,n),t.restore()}this.children.length&&this.children.forEach(function(n){return n.paint&&n.paint(t,e,i)}),this.needUpdate=!1}},{key:"update",value:function(t,e,i,n){!this._startTime&&(this._startTime=t),this._runBehaviors(t,e,i,n),this.children.length&&this.children.forEach(function(a,r,s){a.destroy?s.splice(r,1):a.update(t,e,i,n)}),this.needUpdate&&(n.isStatic=!1)}},{key:"append",value:function(){for(var t=this,e=this.children,i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];e.push.apply(e,n),n.forEach(function(e){return e.$parent=t}),r(e,"zindex")}},{key:"addBehaviors",value:function(){for(var t,e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];this._behaviorsSigned(i),(t=this.behaviors).push.apply(t,i)}},{key:"_behaviorsSigned",value:function(t){t.forEach(function(t){!t._bid&&(t._bid=+new Date)})}},{key:"_runBehaviors",value:function(t,i,n,a){var r=this.behaviors,s=this._startTime,o=!0,u=!1,h=void 0;try{for(var l,c=r[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var f=l.value;if(f.delay){if(t-s-f.delay<0)continue;t=t-s-f.delay}e(f.execute,"function")&&f.execute(this,t,i,n,a)}}catch(t){u=!0,h=t}finally{try{!o&&c.return&&c.return()}finally{if(u)throw h}}}},{key:"$path",get:function(){return this._path}}]),s}(),P=function(){function t(i){u(this,t),this.image=null,this.paint_queue=[],this.photo=null,e(i,"function")&&(this.paint=i.bind(this))}return h(t,[{key:"paint",value:function(t,e,i,n,a){}},{key:"addQueueFn",value:function(t){var i=e(t,"function")?t:e(this[t],"function")?this[t]:null;i&&this.paint_queue.push(i)}},{key:"clearQueue",value:function(){this.paint_queue=[]}},{key:"runQueue",value:function(t,e,i,n,a){for(var r=this.paint_queue,s=0;s<r.length;s++)r[s](t,e,i,n,a)}},{key:"_setSelfStyles",value:function(t,e){t.opacity<1&&(e.globalAlpha=t.opacity>0?t.opacity:0)}},{key:"rotate",value:function(t,e,i,n,a){var r;e.translate(t.rotatePoint.x,t.rotatePoint.y),e.rotate((r=t.rotate,Math.PI/180*r)),t.left=-t.width/2,t.top=-t.height/2}},{key:"getPhoto",value:function(t,e){t.$data.photo=e.getImageData(t.left,t.top,t.width,t.height)}},{key:"putPhoto",value:function(t,e){e.putImageData(t.$data.photo,t.left,t.top)}}]),t}(),w=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments[1];u(this,e);var n=f(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.image=t,n.imgSet=i||{x:0,y:0,w:t&&t.width,h:t&&t.height},n}return c(e,P),h(e,[{key:"paint",value:function(t,e,i,n,a){if(this.image){e.save();var r=Object.assign({},t);this._setSelfStyles(r,e),this.runQueue(r,e,i,n,a);var s=this.imgSet;e.drawImage(this.image,s.x,s.y,s.w,s.h,r.left,r.top,r.width,r.height),e.restore()}}}]),e}(),A=function(t){function e(t,i,n){var a=n.interval,r=void 0===a?1e3:a,s=n.autoruning,o=void 0!==s&&s,h=n.iteration,l=void 0===h?1:h,c=n.reverse,v=void 0!==c&&c;u(this,e);var d=f(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return d.image=t,d.cells=i,d.reverse=v,d.cell_index=v?d.cells.length-1:0,d.interval=r,d.running=!!o,d.frame_point=0,d.timeline=0,d.iteration="infinite"==l?l:parseInt(l),d._countFramePoint(d.cell_index),d}return c(e,P),h(e,[{key:"advance",value:function(){(this.reverse?1==this.cell_index:this.cell_index==this.cells.length-2)&&(this.frame_point=this.timeline=0,Number.isInteger(this.iteration)&&this.iteration--),this.reverse?this.cell_index+=this.cells.length-1:this.cell_index++,this.cell_index%=this.cells.length,this._countFramePoint(this.cell_index)}},{key:"_countFramePoint",value:function(t){var e=(this.reverse?t+this.cells.length-1:t+1)%this.cells.length;this.frame_point+=this._sValue(this.cells[e].interval,this.interval)}},{key:"skip",value:function(t){this.cell_index=t%this.cells.length}},{key:"paint",value:function(t,e,i,n,a){if(this.running){(this.iteration>0||"infinite"==this.iteration)&&this.timeline>=this.frame_point&&this.advance();var r=this.cells[this.cell_index],s=r.img?this.image[r.img]:this.image,o=this._sValue;e.save(),e.drawImage(s,r.x,r.y,r.w,r.h,o(r.sl,t.left),o(r.st,t.top),o(r.sw,t.width),o(r.sh,t.height)),this.timeline+=n,e.restore()}}},{key:"_sValue",value:function(t,e){return Number.isFinite(t)?t:e}}]),e}(),I=function(){function t(i){u(this,t),this._animation=e(i,"function")?i:function(){},this.startTime=0,this.lastTime=0,this.running=!1,this._playing=!1,this.time=0,this.elapsed=0,this.frameRate=0,this._lastFRupdate=0,this._animHandle=null}return h(t,[{key:"updateFrameRate",value:function(t,e){t-this._lastFRupdate>1e3&&(this._lastFRupdate=t,this.frameRate=Math.round(1e3/e))}},{key:"start",value:function(){var t=this;if(!this.running){this.startTime=+new Date,this.running=!0,this.play();this._animHandle=window.requestAnimationFrame(function e(i){t._playing&&(!t.lastTime&&(t.lastTime=i),t.time=i-t.lastTime,t.elapsed+=t.time,t.lastTime=i,t.updateFrameRate(t.elapsed,t.time),t._animation(t.elapsed,t.time)),t._animHandle=window.requestAnimationFrame(e)})}}},{key:"play",value:function(){this._playing=!0}},{key:"pause",value:function(){this.lastTime=0,this.frameRate=0,this._playing=!1}},{key:"stop",value:function(){this.elapsed=+new Date-this.startTime,this.running=!1,this.frameRate=0,window.cancelAnimationFrame(this._animHandle)}},{key:"getElapsedTime",value:function(){return this.running?+new Date-this.startTime:this.elapsed}},{key:"getRuningTime",value:function(){return this.time}},{key:"getNextTime",value:function(){var t=this.time/this.duration;if(this.running)return void 0==this.timeWrap?elapsedTime:elapsedTime*(this.timeWarp(t)/t)}},{key:"isRunning",value:function(){return this.running}},{key:"reset",value:function(){this.elapsed=0}}],[{key:"getWarpTime",value:function(t,e,i){if("function"==typeof t){var n=e/i;return e*t(n)/n}}},{key:"easeIn",value:function(t){return function(e){return Math.pow(e,2*t)}}},{key:"easeOut",value:function(t){return function(e){return 1-Math.pow(1-e,2*t)}}},{key:"easeInOut",value:function(){return function(t){return t-Math.sin(2*t*Math.PI)/(2*Math.PI)}}},{key:"elastic",value:function(t){return t=t||this.def_opts.elastic_passes,function(e){return(1-Math.cos(e*Math.PI*t))*(1-e)+e}}},{key:"bounce",value:function(e){var i=t.elastic(e);return function(){return percent_complete=i(percent_complete),percent_complete<=1?percent_complete:2-percent_complete}}},{key:"linear",value:function(){return function(t){return t}}},{key:"step",value:function(){return function(t){return t}}}]),t}(),O=function(){function t(i,n){u(this,t);Object.assign(this,{firstFn:null,animation:null,iteration:1,timing:null,fillMode:null},i),this.executeFn=e(n,"function")?n:this.animation?this._attrChange:function(){},this.timing=e(this.timing,"function")?this.timing:e(I[this.timing],"function")?I[this.timing](this.timingArgs):null,this.firstFn=e(this.firstFn,"function")?this.firstFn:function(){},this._firstRun=!1,this._iterationCount=0,this._spriteAttrs={},this._animaProps=this._animaInitProps(),this._animaRuntime=null}return h(t,[{key:"_animaInitProps",value:function(){return{velocity:l({left:0,top:0,rotate:0,width:0,height:0,opacity:0},"rotate",0),lastFrame:0,frameDuration:0,framesTime:[]}}},{key:"execute",value:function(t,i,n,a,r){var s=this;this._firstRun||(this._remeberAttrs(t),this._animationPrepare(t),this.firstFn(),this._iterationCount++,this._firstRun=!0);var o=Math.floor(i/this.duration);if(o===this._iterationCount&&(this._checkIterationCount(o)&&(this._iterationCount++,this._animationPrepare(t)),"forward"!==this.fillMode&&this._remeberAttrs(t,!0)),this._checkIterationCount(o)){if(i%=this.duration,this.animation){var u=this._animaRuntime,h=this.animation,l=u.framesTime[0];if(i>=this._countFrameDuration(l)){var c=u.lastFrame=u.framesTime.shift();l=u.framesTime[0],u.frameDuration=this._countFrameDuration(l-c),u.velocity=this._attrChangeInit(t,h[l],u.frameDuration)}if(this.timing&&u.frameDuration){var f=this._warpTime(i,u.frameDuration);i=f[0],n=f[1]}}else if(this.timing&&this.duration){var v=this._warpTime(i,this.duration);i=v[0],n=v[1]}this.executeFn(t,i,n,a,r)}else{e(this.animateCallback,"function")&&this.animateCallback(t,r);var d=t.behaviors.findIndex(function(t){return t._bid===s._bid});t.behaviors.splice(d,1)}}},{key:"_countFrameDuration",value:function(t){return t*this.duration/100}},{key:"_checkIterationCount",value:function(t){return"infinite"===this.iteration||t<this.iteration}},{key:"_animationPrepare",value:function(t){if(this.animation){this._setAnimaData(),!this.animation[0]&&!this.animation[100]&&(this.animation={0:null,100:this.animation});var e=this.animation,i=this._animaRuntime;for(var n in e)0===n&&e[0]&&this._spriteAttrSet(t,e[0],!0),i.framesTime.push(n);i.framesTime.sort(function(t,e){return t-e})}}},{key:"_setAnimaData",value:function(){this._animaRuntime=this._animaInitProps()}},{key:"_warpTime",value:function(t,e){var i=t/e,n=this.timing(i)/i*t;!this.lastTime&&(this.lastTime=n);var a=n-this.lastTime;return this.lastTime=n,this.orgTime=[n,a],this.orgTime}},{key:"_attrChangeInit",value:function(t,e,i){var n={};for(var a in e){var r=e[a],s=0;s="string"==typeof r?this._handleRelativeValue(r):r-t[a],n[a]=s/i}return n}},{key:"_attrChange",value:function(t,e,i,n,a){var r=this._animaRuntime.velocity;for(var s in r)t[s]+=r[s]*i}},{key:"_spriteAttrSet",value:function(t,e,i){for(var n in e)t[n]=i?this._handleRelativeValue(e[n],t[n]):e[n]}},{key:"_handleRelativeValue",value:function(t,e){var n=0;if("string"==typeof t&&t.indexOf("=")>0){var a=t.split("=");switch(a[0]){case"+":n=a[1]-0;break;case"-":n=-a[1]}}return i(e)&&(n+=e),n}},{key:"_remeberAttrs",value:function(t,e){if(1===Object.keys(t.behaviors).length&&(this.iteration>1||"infinite"===this.iteration)){var i=this._spriteAttrs,n=this._animaProps.velocity;if(0===Object.keys(i).length&&!e)for(var a in n)i[a]=t[a];e&&i&&this._spriteAttrSet(t,i)}}}]),t}(),R=function(){function t(){var e=this;u(this,t),this.loadImage=function(t,i,n,a){e.loadMedias("images",t,i,n,a)},this.getImageProgress=function(){return e.getProgress("images")},this.loadAudio=function(t,i,n,a){e.loadMedias("audios",t,i,n,a)},this.getAudioProgress=function(){return e.getProgress("audios")},this.getMediaProgress=function(){var t=e.imagesInfo.queue,i=e.audiosInfo.queue,n=i.s+i.f+t.s+t.f,a=i.t+t.t;return[n,a,Math.round(n/a*100)]},this.imagesInfo=this._mediaInfoObj(),this.images={},this.audiosInfo=this._mediaInfoObj(),this.audios={}}return h(t,[{key:"_mediaInfoObj",value:function(){return{total:{s:0,f:0,t:0},queue:{s:0,f:0,t:0},urls:[]}}},{key:"loadingMedia",value:function(t,e){return this.loadingImages(t.images||{},e,!0),this.loadingAudios(t.audios||{},e,!0),this}},{key:"loadingMediaList",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!!Array.isArray(e),r=this[t+"Info"],s=null;if("images"===t?s=this.loadImage:"audios"===t&&(s=this.loadAudio),e&&r&&s)for(var o in r.queue={s:0,f:0,t:0},e){s(a?e[o]:o,e[o],i,n)}return this}},{key:"loadingImages",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.loadingMediaList("images",t,e,i)}},{key:"loadMedias",value:function(t,e,i,n,a){var r=this[t+"Info"];if(Array.indexOf(r.urls,i)<0){r.total.t++,r.queue.t++,r.urls.push(i);var s=a&&this.getMediaProgress,o=null,u="load";"images"===t?(o=new Image,!a&&(s=this.getImageProgress)):"audios"===t&&(o=new Audio,!a&&(s=this.getAudioProgress),u="loadedmetadata"),o&&(o.addEventListener(u,function(){r.total.s++,r.queue.s++,100==s()[2]&&n()}),o.addEventListener("error",function(){r.total.f++,r.queue.f++,100==s()[2]&&n()}),o.src=i,this[t][e]=o)}}},{key:"loadingAudios",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.loadingMediaList("audios",t,e,i)}},{key:"getProgress",value:function(t){var e=this[t+"Info"].queue,i=e.s+e.f,n=Math.round(i/e.t*100);return[i,e.t,n]}}]),t}(),x=Object.keys(d.eventMap),T=function(){function t(e,i){var n=this;u(this,t),this._RAF=0,this._stages=[],this.$stages={},this.$stage=null,this.$layers={},this.$media=new R,this.eventHandle=function(t){var e=d.eventMap[t.type];if(e){var i=n._stages;d.eventCapture(i,t),d.eventBubbling(t,e).forEach(function(t){return t()})}},this.animation=function(t,e){n._stages.forEach(function(i){return i.update(t,e)})},this.append=function(){for(var t,e=arguments.length,i=Array(e),a=0;a<e;a++)i[a]=arguments[a];i.forEach(function(t){!n.$layers[t.name]&&(n.$layers[t.name]=t)}),(t=n.$stage).append.apply(t,i)},this._elem=this.elemInit(e),this._options=Object.assign({},i),this._aniTimer=new I(this.animation),this.stageInit()}return h(t,[{key:"elemInit",value:function(t){return e(t,"string")?document.querySelector(t):null}},{key:"stageInit",value:function(){if(this._elem){this.eventListening();var t=this._options,e=t.width,i=t.height;this.createStage("MAIN",{width:e,height:i,zIndex:1e3},{left:0,top:0}),this.$stage=this.$stages.MAIN}else s("no accessable root element!")}},{key:"eventListening",value:function(){var t=this;x.forEach(function(e){t._elem.addEventListener(e,t.eventHandle)})}},{key:"createStage",value:function(t,i){if(e(t,"string")&&!this.$stages[t]){var n=this._options,a=n.width,s=n.height;!i.width&&(i.width=a),!i.height&&(i.height=s);var o=new _(t,i);this.$stages[t]=o,this._stages.push(o),r(this._stages,"zIndex"),this._elem.appendChild(o.$canvas)}}},{key:"start",value:function(){this._aniTimer.start()}},{key:"play",value:function(){this._aniTimer.play()}},{key:"pause",value:function(){this._aniTimer.pause()}},{key:"stop",value:function(){this._aniTimer.stop()}},{key:"setCanvasSize",value:function(){var t=this._options,e=t.width,n=t.height;i(e)&&i(n)&&Object.assign(this.canvas,{width:e,height:n})}},{key:"loadingMedia",value:function(t,e){(t.images||t.audios)&&this.$media.loadingMedia(t,e)}},{key:"createPainter",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];switch(t){case"image":return new w([].concat(i));case"sheet":return new A([].concat(i));default:return new P(t)}}},{key:"resize",value:function(t){e(t,"object")&&Object.assign(this._elem,t)}},{key:"$elemSize",get:function(){var t=this._options;return{width:t.width,height:t.height}}},{key:"frameRate",get:function(){return this._aniTimer.frameRate}}]),t}();return T.Sprite=b,T.Painter=P,T.ImagePainter=w,T.SheetPainter=A,T.Behavior=O,T});
